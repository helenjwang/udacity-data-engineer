This is my final capstone project, 2016 Immigration Data Model.

###Project summary:

The project follows the follow steps:
Step 1: Scope the Project and Gather Data
Step 2: Explore and Assess the Data
Step 3: Define the Data Model
Step 4: Run ETL to Model the Data
Step 5: Complete Project Write Up

###What I have used:
1. used the immigration dataset and city demographics dataset. 
2. stored my data in a star schema in a Postgres database.
3. used that star schema to answer questions about where (i.e., what countries) immigrants were coming from and where in the U.S. they were headed to.

###Details explanation for each step:
1. Step 1: Scope the Project and Gather Data
1.1 Scope
pandas to read the data and load it into Postgres. then did all the ETL and analysis in SQL

1.2 Describe and Gather Data
1.2.1: split the immigration dataset up into a single fact_immmigration table and several dim_ dimension tables. 
1.2.2: aggregated The city demographics dataset into state-level statistics in another dimention table.

2 Step 2: Explore and Assess the Data

2.1 Immigration Data
My SQL exploration steps are detailed in the Data Quality Checks section below.
1. creating dim tables for many of the coded fields, like i94res i94cit, and i94visa. Any data in those columns that didn't match a key in those dim tables would be interpreted as "unknown."
2. two columns that could be cleaned. The first is i94bir, which is the age of the respondent in years. In this case I will set anything less than zero and the two 1812 values to NULL. biryear is the reported birth year of entrants and most of its dates range from 1900 - 2016, but there are two instances of 204, two of 2018, and one from 2019. Since this data is from 2016 those cases will all get set to NULL.
3. cleaning columns like i94addr where the values provided was out of the boundaries. But some columns contains useful information so I didn't clean all of them. 

2.2 City Demographics Data
1. Assuming that the Male Population and Female Population numbers add up to Total Population whenever they are present. 
2. Assuming that Number of Veterans, Race, and Foreign-born are less than Total Population whenever they are present.
3. Seeing that the total of Count for all the races adds up to more than Total Population, indicating people must have been allowed to select more than one race for themselves in the survey.
4. Selecting distinct state codes to be sure that the number was near 50 

3 Step 3: Define the Data Model
3.1 Conceptual Data Model
3.1.1 put the immigration data at the center of my star schema in a table called fact_immigration. This is primarily that data loaded into a table, 
3.1.2 With the help of the immigration data header file, I was able to create several dimension tables around it:
dim_country
dim_arrival_mode
dim_port
dim_address
dim_visa_type

3.2 Mapping Out Data Pipelines

3.2.1 dim_arrival_mode and dim_visa_type：generated by manually creating simple INSERT statements.

3.2.2 dim_address, dim_port, and dim_country
generated by:
3.2.2.1 Inspecting the line numbers where their details are listed in the header file
3.2.2.2 writing regular expressions
3.2.2.3 writing a script to parse values from those lines and insert the values

3.2.3 dim_city and dim_state: ready to be inserted into the database

3.2.4 fact_immigration
3.2.4.1 reading in each of the 12 files into a dataframe and then inserting each dataframe into the table. 
3.2.4.2 after each insert we delete the dataframe from memory before reading in the next file. 

4. Step 4: Run Pipelines to Model the Data¶

4.1 Data Quality Checks
row counts for fact_immigration
4.2 Data dictionary

4.2.1 fact_immigration
The grain is an immigration event
immigration_id: primary key
cicid: unique key within a month
i94yr: 4 digit year, always 2016
i94mon: numeric month, 1-12
i94cit: immigrant's country of citizenship; foreign key to dim_country
i94res: immigrant's country of residence outside US; foreign key to dim_country
i94port: port of entry; foreign key to dim_port
arrdate: arrival date of immigrant where 20454 == 1/1/2016
i94mode: mode of arrival; foreign key to dim_arrival_mode
i94addr: address (usually state) of immigrant in US; foreign key to dim_address
depdate: departure date of immigrant where 20454 == 1/1/2016
i94bir: immigrant's age in years
i94visa: foreign key to dim_visa_type
count: used for summary statistics; always 1 (for easy adding)
dtadfile: dates in the format YYYYMMDD
visapost: three-letter codes corresponding to where visa was issued
occup: occupation in US of immigration. Mostly STU for student, also many OTH for other
entdepa: one-letter arrival code
entdepd: one-letter departure code
entdepu: one-letter update code
matflag: M if the arrival and departure records match
biryear: four-digit year of birth
dtaddto: MMDDYYYY date field for when the immigrant is admitted until
gender: mostly M and F, but some X and U as well
insnum: Immigration and Naturalization Services number; many re-used
airline: Airline of entry for immigrant
admnum: admission number; many re-used, but not as much as insnum
fltno: flight number of immigrant
visatype: short visa codes like WT, B2, WB, etc.

4.2.2  dim_city
Provides population statistics on cities in the US. Grain is city/state/race.
city: city's name
state: state city is in
median_age: median age of city
male_pop: number of men in the city
female_pop: number of women in the city
total_pop: number of people in the city
num_vets: number of veterans in the city
foreign_born: number of foreign-born people in the city
avg_household_size: average household size
state_code: two-letter code for state
race: White, Hispanic or Latino, Asian, Black or African-American, or American Indian and Alaska Native
count: number of people of that race in the city

4.2.3 dim_state
Aggregated statistics from dim_city by state
state_code: two-letter code for state
male_pop: number of men in the state
female_pop: number of women in the state
total_pop: number of people in the state
foreign_born: number of foreign-born people in the state

4.2.3
dim_country
A list of countries and their codes that appear in fact_immigration.i94cit and fact_immigration.i94res
code: a numbered code
name: usually a name of a country. There are many that start with INVALID: as well as several different No Country Code values

4.2.4 dim_address
A list of the states (usually) where immigrants list their address
code: mostly two-letter codes for states. There's DC, GU (Guam), and 99 (All Other Codes) as well
name: name of state, region, etc.

4.2.5 dim_port
A list of the ports of arrival
code: a short code
name: the name of the port; there are some No PORT Code values too

4.2.6 dim_date
A list of dates in different formats
code: the CIC code for date where 20454 is 1/1/2016
year: four-digit year
month: month; 1-12
day: day; 1-31
day_of_week: 0 for Monday, 1 for Tuesday, ..., 7 for Sunday
ymd_dash: date formatted as YYYY-MM-DD
ymd_nodash: date formatted as YYYYMMDD
mdy_noash: date formatted as MMDDYYYY

4.2.7 dim_arrival_mode
How immigrants arrived. Foreign key to fact_immigration.i94mode
code: 1, 2, 3, or 9
mode: Air, Sea, Land, or Not reported, respectively

4.2.8 dim_visa_type
The type of visa the immigrant is coming in on. Foreigy key to fact_immigration.i94visa
code: 1, 2, or 3
visa_type: Business, Pleasure, or Student, respectively

5. Step 5: Complete Project Write Up

5.1 Rationale
Tools and technologies
Python and Pandas can easily read all the data formats provided and then easily get them into a relational database.

The data was structured and formatted so good that it can just use a SQL relational database. Postgres is chosen because it is used in the corse

5.2 Data Model
1. Work immigration data with the city and state dimensions because the i94addr column indicates the state where the entrants have an address. 
2. ability to see what states immigrants were heading to, like 1: those states have a higher-percentage of foreign-born residents 2: whether men are heading to states with a higher-percentage of women, etc.

5.3 Updates

What data should be update in the future
5.3.1 fact_immigration needs to be updated monthly;
5.3.2 all dim_ tables source from the immigration data can be dropped and recreated completely;
5.3.3 dim_city and dim_state don't have a time component but when new data is available, they should be updated with date columns
5.3.4 dim_date should be kept up to date. 

What if the data gets large:
1. convert the fact_immigration data to a format readable by Redshift Spectrum;
2. land the data to S3, partitioned by date;
3. create an external schema so Redshift Spectrum could read it in a schema-on-read fashion.
4. write an Airflow DAG using a S3Sensor that starts upon its arrival and then parse the data, land it in its date-partitioned location in S3
